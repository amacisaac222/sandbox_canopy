<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CanopyIQ - Human Approvals</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">üîí CanopyIQ</div>
            <nav>
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href="/dashboard">Dashboard</a></li>
                    <li><a href="/approvals">Approvals</a></li>
                    <li><a href="/docs">API Docs</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
                <h1 class="page-title">Human-in-the-Loop Approvals</h1>
                <p class="page-subtitle">Review and approve high-risk agent actions</p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button onclick="window.location.reload()" class="btn btn-primary">
                    üîÑ Refresh
                </button>
                <a href="/dashboard" class="btn" style="background: var(--gray-100); color: var(--text-primary);">
                    üìä Dashboard
                </a>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="card-grid" style="margin-bottom: 2rem;">
            <div class="card">
                <div class="card-title">Pending Reviews</div>
                <div class="card-value" style="color: var(--primary-amber);">
                    {% set pending_count = rows | selectattr("status", "equalto", "pending") | list | length %}
                    {{ pending_count }}
                </div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">Require immediate attention</div>
            </div>

            <div class="card">
                <div class="card-title">Approved Today</div>
                <div class="card-value" style="color: var(--primary-indigo);">
                    {% set approved_count = rows | selectattr("status", "equalto", "approved") | list | length %}
                    {{ approved_count }}
                </div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">Actions cleared for execution</div>
            </div>

            <div class="card">
                <div class="card-title">Denied Today</div>
                <div class="card-value" style="color: var(--primary-amber);">
                    {% set denied_count = rows | selectattr("status", "equalto", "denied") | list | length %}
                    {{ denied_count }}
                </div>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">Threats blocked by human review</div>
            </div>
        </div>

        <!-- Approval Queue -->
        <div class="table-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3>Approval Queue</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <span style="font-size: 0.875rem; color: var(--text-secondary);">
                        Auto-refresh in <span id="countdown">30</span>s
                    </span>
                    <select style="padding: 0.5rem; border: 1px solid var(--neutral-200); border-radius: 4px;">
                        <option>All Statuses</option>
                        <option>Pending Only</option>
                        <option>Approved</option>
                        <option>Denied</option>
                    </select>
                </div>
            </div>

            {% if rows %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Request Details</th>
                        <th>Agent & Tool</th>
                        <th>Risk Assessment</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in rows %}
                    <tr style="{% if r.status == 'pending' %}background: rgba(245, 158, 11, 0.05);{% endif %}">
                        <td>
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">Request #{{ r.id }}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                Created: Just now
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                Hash: {{ r.params_hash[:16] }}...
                            </div>
                        </td>
                        
                        <td>
                            <div style="font-weight: 600; color: var(--primary-indigo);">{{ r.agent_id }}</div>
                            <div style="font-size: 0.875rem; margin-top: 0.25rem;">
                                <span style="background: var(--gray-100); padding: 0.25rem 0.5rem; border-radius: 4px; font-family: monospace;">
                                    {{ r.tool }}
                                </span>
                            </div>
                        </td>
                        
                        <td>
                            {% if r.tool == "email.send" %}
                            <div style="font-size: 0.875rem;">
                                <div style="color: var(--primary-amber); font-weight: 600;">‚ö†Ô∏è Medium Risk</div>
                                <div style="color: var(--text-secondary); margin-top: 0.25rem;">External email recipient</div>
                            </div>
                            {% else %}
                            <div style="font-size: 0.875rem;">
                                <div style="color: var(--primary-indigo); font-weight: 600;">‚úÖ Low Risk</div>
                                <div style="color: var(--text-secondary); margin-top: 0.25rem;">Standard operation</div>
                            </div>
                            {% endif %}
                        </td>
                        
                        <td>
                            {% if r.status == "pending" %}
                            <span class="status-indicator status-warning">
                                <span class="status-dot warning"></span>
                                Pending Review
                            </span>
                            {% elif r.status == "approved" %}
                            <span class="status-indicator status-success">
                                <span class="status-dot success"></span>
                                Approved
                            </span>
                            {% else %}
                            <span class="status-indicator status-danger">
                                <span class="status-dot danger"></span>
                                Denied
                            </span>
                            {% endif %}
                        </td>
                        
                        <td>
                            {% if r.status == "pending" %}
                            <div style="display: flex; gap: 0.5rem;">
                                <form method="post" action="/v1/approvals/{{ r.id }}/decision" style="display: inline;">
                                    <button name="decision" value="approve" class="btn btn-success btn-sm approve-btn" 
                                            data-approval-id="{{ r.id }}">
                                        ‚úÖ Approve
                                    </button>
                                </form>
                                <form method="post" action="/v1/approvals/{{ r.id }}/decision" style="display: inline;">
                                    <button name="decision" value="deny" class="btn btn-danger btn-sm deny-btn"
                                            data-approval-id="{{ r.id }}">
                                        ‚ùå Deny
                                    </button>
                                </form>
                            </div>
                            {% else %}
                            <span style="font-size: 0.875rem; color: var(--text-secondary);">
                                {% if r.status == 'approved' %}‚úÖ{% else %}‚ùå{% endif %} {{ r.status.title() }}
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üéâ</div>
                <h3 style="margin-bottom: 0.5rem;">No Pending Approvals</h3>
                <p>All agent actions are running smoothly within policy guidelines.</p>
            </div>
            {% endif %}
        </div>

        <!-- Quick Actions -->
        <div style="background: white; border-radius: 12px; padding: 1.5rem; margin-top: 2rem;">
            <h3 style="margin-bottom: 1rem;">Quick Actions</h3>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <a href="/dashboard" class="btn btn-primary">üìä View Dashboard</a>
                <a href="/v1/audit/export?frm=0&to=9999999999" class="btn" style="background: var(--gray-100); color: var(--text-primary);">
                    üì• Export Audit Log
                </a>
                <button onclick="window.print()" class="btn" style="background: var(--gray-100); color: var(--text-primary);">
                    üñ®Ô∏è Print Report
                </button>
            </div>
        </div>
    </div>

    <script src="/static/js/dashboard.js"></script>
    <script>
        // Auto-refresh countdown
        let countdown = 30;
        const countdownElement = document.getElementById('countdown');
        
        setInterval(() => {
            countdown--;
            if (countdownElement) {
                countdownElement.textContent = countdown;
            }
            if (countdown <= 0) {
                window.location.reload();
            }
        }, 1000);

        // Add timestamp formatting (simple version)
        document.addEventListener('DOMContentLoaded', () => {
            // In a real app, you'd use moment.js or date-fns
            const timestamps = document.querySelectorAll('[data-timestamp]');
            timestamps.forEach(el => {
                const timestamp = parseInt(el.dataset.timestamp);
                const date = new Date(timestamp * 1000);
                el.textContent = date.toLocaleString();
            });
        });
    </script>
</body>
</html>