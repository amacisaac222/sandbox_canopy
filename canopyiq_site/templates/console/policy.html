{% extends "base.html" %}

{% block content %}
<div class="bg-navy-900 min-h-screen">
  <!-- Breadcrumb -->
  <div class="bg-navy-800 border-b border-navy-700">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <nav class="flex items-center space-x-2 text-sm">
        <a href="/admin/console" class="text-navy-300 hover:text-coral-400 font-semibold">Console</a>
        <svg class="w-4 h-4 text-navy-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
        <span class="text-white font-semibold">Policy Management</span>
      </nav>
    </div>
  </div>

  <!-- Header -->
  <div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-white">Policy Management</h1>
    <p class="text-navy-300 mt-2">Upload, diff, and rollout policy changes</p>
  </div>

  <!-- Content -->
  <div class="max-w-6xl mx-auto px-4 pb-12 space-y-8">
    
    <!-- Current Status -->
    <div class="bg-navy-800 border border-navy-700 rounded-lg p-6">
      <h2 class="text-xl font-bold text-white mb-4">Current Status</h2>
      
      {% if policy_status %}
        <div class="grid md:grid-cols-3 gap-4 text-sm">
          <div class="bg-navy-700 rounded p-4">
            <div class="text-navy-400 font-semibold mb-1">Active Version</div>
            <div class="text-white font-bold">{{ policy_status.get('active_version', 'Unknown') }}</div>
          </div>
          <div class="bg-navy-700 rounded p-4">
            <div class="text-navy-400 font-semibold mb-1">Canary Version</div>
            <div class="text-amber-400 font-bold">{{ policy_status.get('canary_version', 'None') }}</div>
          </div>
          <div class="bg-navy-700 rounded p-4">
            <div class="text-navy-400 font-semibold mb-1">Canary Traffic</div>
            <div class="text-blue-400 font-bold">{{ policy_status.get('canary_percent', 0) }}%</div>
          </div>
        </div>
      {% elif status_error %}
        <div class="bg-amber-500/20 border border-amber-500/30 rounded p-4">
          <div class="flex items-center gap-2 text-amber-400 mb-1">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="font-semibold">Status Unavailable</span>
          </div>
          <p class="text-amber-300 text-sm">{{ status_error }}</p>
        </div>
      {% else %}
        <div class="bg-navy-700 rounded p-4 text-center">
          <div class="text-navy-400 text-sm">Policy status information not available</div>
        </div>
      {% endif %}
    </div>

    <!-- Upload Form -->
    <div class="bg-navy-800 border border-navy-700 rounded-lg p-6">
      <h2 class="text-xl font-bold text-white mb-4">Policy Diff</h2>
      <form method="post" enctype="multipart/form-data" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label for="current" class="block text-sm font-semibold text-white mb-2">Current Policy (Optional)</label>
            <input type="file" id="current" name="current" accept=".yaml,.yml" 
                   class="w-full bg-navy-700 border border-navy-600 text-white rounded px-3 py-2 text-sm">
            <p class="text-xs text-navy-400 mt-1">Leave empty to use live policy</p>
          </div>
          <div>
            <label for="proposed" class="block text-sm font-semibold text-white mb-2">Proposed Policy</label>
            <input type="file" id="proposed" name="proposed" accept=".yaml,.yml" required
                   class="w-full bg-navy-700 border border-navy-600 text-white rounded px-3 py-2 text-sm">
          </div>
        </div>
        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded font-semibold transition-colors">
          Generate Diff
        </button>
      </form>
    </div>

    <!-- Diff Results -->
    {% if diff_result %}
    <div class="bg-navy-800 border border-navy-700 rounded-lg p-6">
      <h2 class="text-xl font-bold text-white mb-4">Diff Results</h2>
      
      {% if diff_result.success %}
        <!-- Risk Level -->
        <div class="flex items-center gap-3 mb-6">
          <span class="text-sm font-semibold text-navy-300">Risk Level:</span>
          {% if diff_result.risk_level == 'high' %}
            <span class="px-3 py-1 bg-red-500/20 text-red-400 font-bold rounded">HIGH RISK</span>
          {% elif diff_result.risk_level == 'medium' %}
            <span class="px-3 py-1 bg-amber-500/20 text-amber-400 font-bold rounded">MEDIUM RISK</span>
          {% else %}
            <span class="px-3 py-1 bg-green-500/20 text-green-400 font-bold rounded">LOW RISK</span>
          {% endif %}
        </div>

        <!-- Summary -->
        <div class="mb-6">
          <h3 class="font-semibold text-white mb-2">Summary</h3>
          <p class="text-navy-300">{{ diff_result.summary }}</p>
        </div>

        <!-- Headlines -->
        {% if diff_result.headline %}
        <div class="mb-6">
          <h3 class="font-semibold text-white mb-3">Key Changes</h3>
          <ul class="space-y-2">
            {% for item in diff_result.headline %}
            <li class="flex items-start gap-2 text-navy-300">
              <svg class="w-4 h-4 mt-0.5 text-amber-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span>{{ item }}</span>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <!-- Rule Changes Grid -->
        <div class="grid md:grid-cols-3 gap-4">
          <!-- Added Rules -->
          {% if diff_result.added_rules %}
          <div class="bg-green-500/10 border border-green-500/20 rounded p-4">
            <h4 class="font-semibold text-green-400 mb-2">Added Rules ({{ diff_result.added_rules|length }})</h4>
            <div class="space-y-1 text-sm">
              {% for rule in diff_result.added_rules %}
              <div class="text-green-300">+ {{ rule.get('name', rule.get('id', 'Unnamed rule')) }}</div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Removed Rules -->
          {% if diff_result.removed_rules %}
          <div class="bg-red-500/10 border border-red-500/20 rounded p-4">
            <h4 class="font-semibold text-red-400 mb-2">Removed Rules ({{ diff_result.removed_rules|length }})</h4>
            <div class="space-y-1 text-sm">
              {% for rule in diff_result.removed_rules %}
              <div class="text-red-300">- {{ rule.get('name', rule.get('id', 'Unnamed rule')) }}</div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Modified Rules -->
          {% if diff_result.modified_rules %}
          <div class="bg-amber-500/10 border border-amber-500/20 rounded p-4">
            <h4 class="font-semibold text-amber-400 mb-2">Modified Rules ({{ diff_result.modified_rules|length }})</h4>
            <div class="space-y-1 text-sm">
              {% for rule in diff_result.modified_rules %}
              <div class="text-amber-300">~ {{ rule.get('name', rule.get('id', 'Unnamed rule')) }}</div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Actions -->
        <div class="mt-6 flex gap-3">
          <button class="bg-navy-700 hover:bg-navy-600 text-navy-200 px-4 py-2 rounded font-semibold transition-colors" disabled>
            Apply to Staging (Stub)
          </button>
          <button class="bg-navy-700 hover:bg-navy-600 text-navy-200 px-4 py-2 rounded font-semibold transition-colors" disabled>
            Schedule Rollout (Stub)
          </button>
        </div>
      {% else %}
        <!-- Error state -->
        <div class="bg-red-500/20 border border-red-500/30 rounded p-4">
          <div class="flex items-center gap-2 text-red-400 mb-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="font-semibold">Diff Failed</span>
          </div>
          <p class="text-red-300 text-sm">{{ diff_result.error }}</p>
        </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- Helpful Note -->
    {% if not diff_result %}
    <div class="bg-navy-800 border border-navy-700 rounded-lg p-6">
      <h3 class="font-semibold text-white mb-2">Getting Started</h3>
      <p class="text-navy-300 text-sm mb-3">Upload a proposed YAML policy to compare against the current live policy and highlight potential risks.</p>
      <div class="space-y-1 text-xs text-navy-400">
        <div>• Upload format: YAML (.yaml or .yml)</div>
        <div>• Diff will highlight added, removed, and modified rules</div>
        <div>• Risk analysis includes security and operational impact</div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}