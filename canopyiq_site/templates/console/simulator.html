{% extends "base.html" %}

{% block content %}
<div class="bg-navy-900 min-h-screen">
  <!-- Breadcrumb -->
  <div class="bg-navy-800 border-b border-navy-700">
    <div class="max-w-7xl mx-auto px-4 py-3">
      <nav class="flex items-center space-x-2 text-sm">
        <a href="/admin/console" class="text-navy-300 hover:text-coral-400 font-semibold">Console</a>
        <svg class="w-4 h-4 text-navy-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/></svg>
        <span class="text-white font-semibold">Policy Simulator</span>
      </nav>
    </div>
  </div>

  <!-- Header -->
  <div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-white">Policy Simulator</h1>
    <p class="text-navy-300 mt-2">Test tool calls against current policies</p>
  </div>

  <!-- Content -->
  <div class="max-w-4xl mx-auto px-4 pb-12">
    <div class="bg-navy-800 border border-navy-700 rounded-lg p-6">
      
      <!-- Simulator Form -->
      <form method="post" class="space-y-6">
        <div>
          <label for="tool" class="block text-sm font-semibold text-white mb-2">Tool Name</label>
          <select id="tool" name="tool" class="w-full bg-navy-700 border border-navy-600 text-white rounded px-3 py-2">
            <option value="net.http" {% if tool == 'net.http' %}selected{% endif %}>net.http</option>
            <option value="fs.write" {% if tool == 'fs.write' %}selected{% endif %}>fs.write</option>
            <option value="cloud.ops" {% if tool == 'cloud.ops' %}selected{% endif %}>cloud.ops</option>
            <option value="mail.send" {% if tool == 'mail.send' %}selected{% endif %}>mail.send</option>
          </select>
        </div>

        <div>
          <label for="arguments" class="block text-sm font-semibold text-white mb-2">JSON Arguments</label>
          <textarea id="arguments" name="arguments" rows="8" 
                    class="w-full bg-navy-700 border border-navy-600 text-white rounded px-3 py-2 font-mono text-sm"
                    placeholder='{"method": "GET", "url": "https://api.example.com/health"}'>{{ arguments or '' }}</textarea>
        </div>

        <button type="submit" class="w-full bg-coral-600 hover:bg-coral-700 text-white py-3 rounded font-semibold transition-colors">
          Simulate Policy Decision
        </button>
      </form>

      <!-- Simulation Results -->
      {% if result %}
      <div class="mt-8 p-6 bg-navy-700 border border-navy-600 rounded-lg">
        <h3 class="text-lg font-semibold text-white mb-4">Simulation Results</h3>
        
        {% if result.success %}
          <!-- Successful simulation -->
          <div class="space-y-4">
            <!-- Decision Badge -->
            <div class="flex items-center gap-3">
              <span class="text-sm font-semibold text-navy-300">Decision:</span>
              {% if result.decision == 'allow' %}
                <span class="px-3 py-1 bg-green-500/20 text-green-400 font-bold text-lg rounded">ALLOW</span>
              {% elif result.decision == 'approval' %}
                <span class="px-3 py-1 bg-amber-500/20 text-amber-400 font-bold text-lg rounded">APPROVAL</span>
              {% else %}
                <span class="px-3 py-1 bg-red-500/20 text-red-400 font-bold text-lg rounded">DENY</span>
              {% endif %}
            </div>
            
            <!-- Rule Info -->
            <div class="grid md:grid-cols-2 gap-4">
              <div>
                <div class="text-sm font-semibold text-navy-300 mb-1">Matched Rule:</div>
                <div class="text-white">{{ result.rule_name }}</div>
              </div>
              <div>
                <div class="text-sm font-semibold text-navy-300 mb-1">Reason:</div>
                <div class="text-navy-200">{{ result.rule_reason }}</div>
              </div>
            </div>
            
            <!-- Request Details -->
            <details class="mt-4">
              <summary class="text-sm font-semibold text-coral-400 cursor-pointer">View Request Details</summary>
              <div class="mt-2 p-3 bg-navy-800 rounded">
                <div class="text-xs font-mono text-navy-200">{{ result.request | tojsonpretty }}</div>
              </div>
            </details>
            
            <!-- Trace Data -->
            {% if result.trace_data %}
            <details class="mt-4">
              <summary class="text-sm font-semibold text-coral-400 cursor-pointer">View Evaluation Trace</summary>
              <div class="mt-2 p-3 bg-navy-800 rounded">
                <div class="text-xs font-mono text-navy-200">{{ result.trace_data | tojsonpretty }}</div>
              </div>
            </details>
            {% endif %}
          </div>
        {% else %}
          <!-- Error state -->
          <div class="bg-red-500/20 border border-red-500/30 rounded p-4">
            <div class="flex items-center gap-2 text-red-400 mb-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <span class="font-semibold">Simulation Failed</span>
            </div>
            <p class="text-red-300 text-sm">{{ result.error }}</p>
          </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- Helper Text -->
      <div class="mt-8 p-4 bg-navy-700 border border-navy-600 rounded-lg">
        <h3 class="font-semibold text-white mb-2">Example Test Cases</h3>
        <div class="space-y-2 text-sm text-navy-300">
          <div><strong>HTTP Request:</strong> <code class="bg-navy-800 px-1 rounded">{"method": "GET", "url": "https://intranet.api/health"}</code></div>
          <div><strong>File Write:</strong> <code class="bg-navy-800 px-1 rounded">{"path": "/tmp/output.txt", "bytes": "SGVsbG8="}</code></div>
          <div><strong>Cloud Ops:</strong> <code class="bg-navy-800 px-1 rounded">{"provider": "aws", "resource": "ec2", "estimated_cost_usd": 5.0}</code></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}