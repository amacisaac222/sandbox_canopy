<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Project Context | AI Governance Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            coral: {
              50: '#fff7f6', 100: '#ffeeec', 200: '#ffd9d4', 300: '#ffb8ad',
              400: '#ff8f7d', 500: '#ff6f61', 600: '#f5553d', 700: '#e0401f',
              800: '#c73314', 900: '#a42e15'
            },
            navy: {
              50: '#f1f4f8', 100: '#dde4ed', 200: '#c0cedf', 300: '#94abca',
              400: '#6182b0', 500: '#3d6199', 600: '#304e80', 700: '#284069',
              800: '#253658', 900: '#1c2a4a'
            }
          }
        }
      }
    }
  </script>
</head>
<body class="bg-navy-50 min-h-screen font-sans">

<!-- Header -->
<header class="bg-white border-b border-navy-200">
  <div class="max-w-7xl mx-auto px-4 py-4">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-black text-navy-900">üß† Project Context Dashboard</h1>
        <p class="text-navy-600 mt-1">Continuous knowledge across Claude Code sessions</p>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-sm text-navy-600">
          <span class="inline-flex items-center px-2 py-1 bg-coral-100 text-coral-800 rounded-full font-bold text-xs">
            Live Context Tracking
          </span>
        </div>
        <a href="/admin" class="text-navy-600 hover:text-coral-500 font-bold">‚Üê Back to Admin</a>
      </div>
    </div>
  </div>
</header>

<div class="max-w-7xl mx-auto px-4 py-8">
  
  <!-- Project Overview -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-white border border-navy-200 rounded-lg p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-bold text-navy-600 uppercase tracking-wide">Total Projects</p>
          <p class="text-3xl font-black text-navy-900 mt-1" id="total-projects">0</p>
        </div>
        <div class="w-12 h-12 bg-coral-100 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-coral-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
          </svg>
        </div>
      </div>
    </div>
    
    <div class="bg-white border border-navy-200 rounded-lg p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-bold text-navy-600 uppercase tracking-wide">Key Findings</p>
          <p class="text-3xl font-black text-navy-900 mt-1" id="total-findings">0</p>
        </div>
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
        </div>
      </div>
    </div>
    
    <div class="bg-white border border-navy-200 rounded-lg p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-bold text-navy-600 uppercase tracking-wide">Next Steps</p>
          <p class="text-3xl font-black text-navy-900 mt-1" id="total-next-steps">0</p>
        </div>
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </div>
      </div>
    </div>
    
    <div class="bg-white border border-navy-200 rounded-lg p-6">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm font-bold text-navy-600 uppercase tracking-wide">Active Sessions</p>
          <p class="text-3xl font-black text-navy-900 mt-1" id="active-sessions">0</p>
        </div>
        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
          <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    
    <!-- Projects List -->
    <div class="bg-white border border-navy-200 rounded-lg">
      <div class="px-6 py-4 border-b border-navy-200">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-black text-navy-900">üìÅ Projects with Context</h2>
          <button onclick="refreshProjects()" class="text-coral-500 hover:text-coral-600 font-bold text-sm">
            üîÑ Refresh
          </button>
        </div>
      </div>
      <div class="p-6">
        <div id="projects-list" class="space-y-4">
          <!-- Projects will be loaded here -->
          <div class="text-center py-8">
            <div class="inline-flex items-center px-4 py-2 bg-coral-100 text-coral-800 rounded-lg">
              <svg class="animate-spin -ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Loading projects...
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Context Details -->
    <div class="bg-white border border-navy-200 rounded-lg">
      <div class="px-6 py-4 border-b border-navy-200">
        <h2 class="text-xl font-black text-navy-900">üîç Selected Project Context</h2>
      </div>
      <div class="p-6">
        <div id="project-context" class="text-center py-8 text-navy-600">
          Select a project to view its context details
        </div>
      </div>
    </div>

  </div>

  <!-- Real-time Context Events -->
  <div class="mt-8">
    <div class="bg-white border border-navy-200 rounded-lg">
      <div class="px-6 py-4 border-b border-navy-200">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-black text-navy-900">‚ö° Live Context Events</h2>
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span class="text-sm font-bold text-green-600">Live</span>
          </div>
        </div>
      </div>
      <div class="p-6">
        <div id="live-events" class="space-y-3 max-h-96 overflow-y-auto">
          <!-- Live events will appear here -->
          <div class="text-center py-4 text-navy-600">
            Waiting for live context events...
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
// Context Dashboard JavaScript
class ContextDashboard {
  constructor() {
    this.projects = [];
    this.selectedProject = null;
    this.websocket = null;
    this.init();
  }

  async init() {
    await this.loadProjects();
    this.connectWebSocket();
    this.startPeriodicRefresh();
  }

  async loadProjects() {
    try {
      const response = await fetch('/api/v1/projects');
      const data = await response.json();
      this.projects = data.projects || [];
      this.renderProjects();
      this.updateStats();
    } catch (error) {
      console.error('Failed to load projects:', error);
      this.showError('Failed to load projects');
    }
  }

  renderProjects() {
    const container = document.getElementById('projects-list');
    
    if (this.projects.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8">
          <div class="w-16 h-16 bg-navy-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-navy-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
          </div>
          <h3 class="text-lg font-bold text-navy-900 mb-2">No Projects Yet</h3>
          <p class="text-navy-600">Project context will appear here once Claude Code sessions begin</p>
        </div>
      `;
      return;
    }

    container.innerHTML = this.projects.map(project => `
      <div class="border border-navy-200 rounded-lg p-4 hover:bg-navy-50 cursor-pointer transition-colors project-card" 
           onclick="contextDashboard.selectProject('${project.project_id}')">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <div class="flex items-center gap-2">
              <h3 class="font-bold text-navy-900">${project.project_name}</h3>
              ${project.technologies.map(tech => `
                <span class="bg-coral-100 text-coral-800 px-2 py-1 rounded text-xs font-bold">${tech}</span>
              `).join('')}
            </div>
            <p class="text-sm text-navy-600 mt-1">${project.project_path}</p>
            <p class="text-xs text-navy-500 mt-1">Last updated: ${new Date(project.last_updated).toLocaleString()}</p>
          </div>
          <div class="text-right">
            <div class="text-xs text-navy-600">
              <div>${project.stats.keyFindings} findings</div>
              <div>${project.stats.nextSteps} next steps</div>
            </div>
          </div>
        </div>
        
        ${project.recentFindings.length > 0 ? `
          <div class="mt-3 pt-3 border-t border-navy-100">
            <p class="text-xs font-bold text-navy-600 mb-1">Recent Findings:</p>
            ${project.recentFindings.map(finding => `
              <p class="text-xs text-navy-600">‚Ä¢ ${finding.text}</p>
            `).join('')}
          </div>
        ` : ''}
        
        ${project.urgentNextSteps.length > 0 ? `
          <div class="mt-2">
            <p class="text-xs font-bold text-red-600 mb-1">Urgent Next Steps:</p>
            ${project.urgentNextSteps.map(step => `
              <p class="text-xs text-red-600">‚ö†Ô∏è ${step.text}</p>
            `).join('')}
          </div>
        ` : ''}
      </div>
    `).join('');
  }

  async selectProject(projectId) {
    // Remove previous selection
    document.querySelectorAll('.project-card').forEach(card => {
      card.classList.remove('ring-2', 'ring-coral-500');
    });
    
    // Highlight selected project
    event.currentTarget.classList.add('ring-2', 'ring-coral-500');
    
    this.selectedProject = projectId;
    await this.loadProjectContext(projectId);
  }

  async loadProjectContext(projectId) {
    try {
      const response = await fetch(`/api/v1/project-context/${projectId}/summary`);
      const data = await response.json();
      this.renderProjectContext(data);
    } catch (error) {
      console.error('Failed to load project context:', error);
      this.showError('Failed to load project context');
    }
  }

  renderProjectContext(context) {
    const container = document.getElementById('project-context');
    
    if (context.error || !context.stats) {
      container.innerHTML = `
        <div class="text-center py-8">
          <p class="text-navy-600">No detailed context available for this project</p>
        </div>
      `;
      return;
    }

    container.innerHTML = `
      <div class="space-y-6">
        <div>
          <h3 class="font-bold text-navy-900 mb-3">üìä Context Statistics</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="bg-navy-50 rounded-lg p-3">
              <div class="text-2xl font-black text-navy-900">${context.stats.objectives}</div>
              <div class="text-sm text-navy-600">Objectives</div>
            </div>
            <div class="bg-navy-50 rounded-lg p-3">
              <div class="text-2xl font-black text-navy-900">${context.stats.decisions}</div>
              <div class="text-sm text-navy-600">Decisions</div>
            </div>
          </div>
        </div>

        ${context.recentFindings.length > 0 ? `
          <div>
            <h3 class="font-bold text-navy-900 mb-3">üîç Recent Key Findings</h3>
            <div class="space-y-2">
              ${context.recentFindings.map(finding => `
                <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                  <div class="text-sm font-bold text-blue-900">${finding.text}</div>
                  <div class="text-xs text-blue-600 mt-1">${finding.category} ‚Ä¢ ${finding.priority} priority</div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        ${context.urgentNextSteps.length > 0 ? `
          <div>
            <h3 class="font-bold text-red-900 mb-3">‚ö†Ô∏è Urgent Next Steps</h3>
            <div class="space-y-2">
              ${context.urgentNextSteps.map(step => `
                <div class="bg-red-50 border-l-4 border-red-500 p-3 rounded">
                  <div class="text-sm font-bold text-red-900">${step.text}</div>
                  <div class="text-xs text-red-600 mt-1">${step.category} ‚Ä¢ High priority</div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        ${context.technologies && context.technologies.length > 0 ? `
          <div>
            <h3 class="font-bold text-navy-900 mb-3">üõ†Ô∏è Detected Technologies</h3>
            <div class="flex flex-wrap gap-2">
              ${context.technologies.map(tech => `
                <span class="bg-coral-100 text-coral-800 px-2 py-1 rounded text-xs font-bold">${tech}</span>
              `).join('')}
            </div>
          </div>
        ` : ''}

        <div class="pt-4 border-t border-navy-200">
          <p class="text-xs text-navy-500">
            Project Path: ${context.projectPath}<br>
            Last Updated: ${new Date(context.last_updated).toLocaleString()}<br>
            Recent Activity: ${context.stats.recentActivity} events
          </p>
        </div>
      </div>
    `;
  }

  connectWebSocket() {
    const wsUrl = window.location.protocol.replace('http', 'ws') + '//' + window.location.host + '/ws/events/dashboard';
    this.websocket = new WebSocket(wsUrl);

    this.websocket.onmessage = (event) => {
      const message = JSON.parse(event.data);
      this.handleLiveEvent(message);
    };

    this.websocket.onclose = () => {
      console.log('WebSocket disconnected, attempting reconnect...');
      setTimeout(() => this.connectWebSocket(), 5000);
    };

    this.websocket.onerror = (error) => {
      console.error('WebSocket error:', error);
    };
  }

  handleLiveEvent(event) {
    if (event.type === 'key_finding_discovered') {
      this.addLiveEvent('üîç', 'Key Finding', event.data.text, 'blue');
    } else if (event.type === 'next_step_identified') {
      this.addLiveEvent('üìã', 'Next Step', event.data.text, 'green');
    } else if (event.type === 'project_context_updated') {
      this.addLiveEvent('üíæ', 'Context Saved', `Updated context for project`, 'purple');
      this.loadProjects(); // Refresh projects
    } else if (event.type === 'live_ai_activity') {
      this.addLiveEvent('ü§ñ', 'AI Activity', `${event.event_type} - ${event.data.tool || 'unknown tool'}`, 'coral');
    }
  }

  addLiveEvent(icon, title, description, color) {
    const container = document.getElementById('live-events');
    const eventElement = document.createElement('div');
    eventElement.className = `flex items-start gap-3 p-3 bg-${color}-50 border border-${color}-200 rounded-lg`;
    eventElement.innerHTML = `
      <div class="text-lg">${icon}</div>
      <div class="flex-1">
        <div class="font-bold text-${color}-900 text-sm">${title}</div>
        <div class="text-${color}-700 text-sm">${description}</div>
        <div class="text-${color}-600 text-xs mt-1">${new Date().toLocaleTimeString()}</div>
      </div>
    `;
    
    // Add to top and limit to 20 events
    container.insertBefore(eventElement, container.firstChild);
    if (container.children.length > 20) {
      container.removeChild(container.lastChild);
    }
  }

  updateStats() {
    document.getElementById('total-projects').textContent = this.projects.length;
    
    const totalFindings = this.projects.reduce((sum, p) => sum + p.stats.keyFindings, 0);
    document.getElementById('total-findings').textContent = totalFindings;
    
    const totalNextSteps = this.projects.reduce((sum, p) => sum + p.stats.nextSteps, 0);
    document.getElementById('total-next-steps').textContent = totalNextSteps;
    
    // Active sessions will be updated via WebSocket
    document.getElementById('active-sessions').textContent = '1'; // Placeholder
  }

  startPeriodicRefresh() {
    setInterval(() => {
      this.loadProjects();
    }, 30000); // Refresh every 30 seconds
  }

  showError(message) {
    console.error(message);
  }
}

// Initialize dashboard
const contextDashboard = new ContextDashboard();

// Global functions
function refreshProjects() {
  contextDashboard.loadProjects();
}
</script>

</body>
</html>