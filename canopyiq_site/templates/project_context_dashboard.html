{% extends "admin_base.html" %}

{% block title %}Context Memory{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-black text-navy-900">üß† Context Memory</h1>
      <p class="text-navy-600 mt-1">Continuous knowledge across Claude Code sessions</p>
    </div>
    <div class="flex items-center gap-4">
      <span class="inline-flex items-center px-3 py-1 bg-coral-100 text-coral-800 rounded-full font-bold text-sm">
        <span class="w-2 h-2 bg-coral-500 rounded-full mr-2 animate-pulse"></span>
        Live Context Tracking
      </span>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white rounded-lg shadow-sm border border-navy-200 p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-coral-100 rounded-lg flex items-center justify-center">
            <span class="text-coral-600 font-bold text-sm" id="total-projects">0</span>
          </div>
        </div>
        <div class="ml-4">
          <p class="text-sm font-semibold text-navy-600">Total Projects</p>
          <p class="text-2xl font-black text-navy-900" id="total-projects-display">0</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-navy-200 p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
            <span class="text-blue-600 font-bold text-sm" id="active-sessions">0</span>
          </div>
        </div>
        <div class="ml-4">
          <p class="text-sm font-semibold text-navy-600">Active Sessions</p>
          <p class="text-2xl font-black text-navy-900" id="active-sessions-display">0</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-navy-200 p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
            <span class="text-green-600 font-bold text-sm" id="key-findings">0</span>
          </div>
        </div>
        <div class="ml-4">
          <p class="text-sm font-semibold text-navy-600">Key Findings</p>
          <p class="text-2xl font-black text-navy-900" id="key-findings-display">0</p>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-navy-200 p-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
            <span class="text-purple-600 font-bold text-sm" id="next-steps">0</span>
          </div>
        </div>
        <div class="ml-4">
          <p class="text-sm font-semibold text-navy-600">Next Steps</p>
          <p class="text-2xl font-black text-navy-900" id="next-steps-display">0</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Dashboard -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Project List -->
    <div class="lg:col-span-1">
      <div class="bg-white rounded-lg shadow-sm border border-navy-200">
        <div class="px-6 py-4 border-b border-navy-200">
          <h2 class="text-lg font-black text-navy-900">Projects</h2>
          <p class="text-sm text-navy-600">Select a project to view context</p>
        </div>
        <div class="p-4">
          <div id="project-list" class="space-y-3">
            <div class="text-center py-8 text-navy-500">
              <div class="text-4xl mb-2">üîÑ</div>
              <p class="text-sm font-semibold">Loading projects...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Context Details -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-lg shadow-sm border border-navy-200">
        <div class="px-6 py-4 border-b border-navy-200">
          <h2 class="text-lg font-black text-navy-900">Project Context</h2>
          <p class="text-sm text-navy-600">Detailed context for selected project</p>
        </div>
        <div class="p-6">
          <div id="context-details">
            <div class="text-center py-12 text-navy-500">
              <div class="text-6xl mb-4">üß†</div>
              <h3 class="text-lg font-bold mb-2">No Project Selected</h3>
              <p class="text-sm">Choose a project from the list to view its context history</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Activity -->
  <div class="bg-white rounded-lg shadow-sm border border-navy-200">
    <div class="px-6 py-4 border-b border-navy-200">
      <h2 class="text-lg font-black text-navy-900">Recent Context Events</h2>
      <p class="text-sm text-navy-600">Live stream of context updates</p>
    </div>
    <div class="p-6">
      <div id="recent-events" class="space-y-4">
        <div class="text-center py-8 text-navy-500">
          <div class="text-4xl mb-2">üìä</div>
          <p class="text-sm font-semibold">Waiting for context events...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
class ContextDashboard {
  constructor() {
    this.ws = null;
    this.projects = new Map();
    this.selectedProject = null;
    this.init();
  }

  init() {
    this.connectWebSocket();
    this.loadProjects();
    this.startStatsUpdate();
  }

  connectWebSocket() {
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/events`;
    
    try {
      this.ws = new WebSocket(wsUrl);
      
      this.ws.onopen = () => {
        console.log('üåê Connected to CanopyIQ real-time events');
        this.showToast('Connected to live context tracking', 'success');
      };

      this.ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          this.handleRealtimeEvent(data);
        } catch (e) {
          console.error('Failed to parse WebSocket message:', e);
        }
      };

      this.ws.onclose = () => {
        console.log('üîå Disconnected from real-time events');
        setTimeout(() => this.connectWebSocket(), 5000);
      };

      this.ws.onerror = (error) => {
        console.error('WebSocket error:', error);
      };
    } catch (error) {
      console.error('Failed to connect to WebSocket:', error);
    }
  }

  async loadProjects() {
    try {
      const response = await fetch('/api/v1/projects');
      if (!response.ok) throw new Error('Failed to load projects');
      
      const projects = await response.json();
      this.renderProjectList(projects);
      this.updateStats();
    } catch (error) {
      console.error('Failed to load projects:', error);
      document.getElementById('project-list').innerHTML = `
        <div class="text-center py-8 text-red-500">
          <div class="text-4xl mb-2">‚ùå</div>
          <p class="text-sm font-semibold">Failed to load projects</p>
          <p class="text-xs mt-1">${error.message}</p>
        </div>
      `;
    }
  }

  renderProjectList(projects) {
    const projectList = document.getElementById('project-list');
    
    if (!projects || projects.length === 0) {
      projectList.innerHTML = `
        <div class="text-center py-8 text-navy-500">
          <div class="text-4xl mb-2">üìÅ</div>
          <p class="text-sm font-semibold">No Projects Yet</p>
          <p class="text-xs mt-1">Context will appear when Claude Code sessions begin</p>
        </div>
      `;
      return;
    }

    projectList.innerHTML = projects.map(project => `
      <div class="project-item p-3 rounded-lg border border-navy-200 hover:border-coral-300 cursor-pointer transition-colors" 
           data-project-id="${project.id}" onclick="dashboard.selectProject('${project.id}')">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="font-bold text-navy-900 text-sm">${this.escapeHtml(project.name)}</h3>
            <p class="text-xs text-navy-600">${project.sessions || 0} sessions</p>
          </div>
          <div class="text-right">
            <div class="text-xs text-navy-500">${this.formatTimestamp(project.lastActivity)}</div>
            <div class="text-xs font-semibold text-coral-600">${project.contextEntries || 0} contexts</div>
          </div>
        </div>
      </div>
    `).join('');
  }

  async selectProject(projectId) {
    this.selectedProject = projectId;
    
    // Update UI selection
    document.querySelectorAll('.project-item').forEach(item => {
      item.classList.remove('border-coral-500', 'bg-coral-50');
    });
    document.querySelector(`[data-project-id="${projectId}"]`)?.classList.add('border-coral-500', 'bg-coral-50');

    try {
      const response = await fetch(`/api/v1/project-context/${projectId}`);
      if (!response.ok) throw new Error('Failed to load project context');
      
      const context = await response.json();
      this.renderProjectContext(context);
    } catch (error) {
      console.error('Failed to load project context:', error);
      this.showToast('Failed to load project context', 'error');
    }
  }

  renderProjectContext(context) {
    const contextDetails = document.getElementById('context-details');
    
    if (!context || !context.context) {
      contextDetails.innerHTML = `
        <div class="text-center py-12 text-navy-500">
          <div class="text-6xl mb-4">üìÑ</div>
          <h3 class="text-lg font-bold mb-2">No Context Available</h3>
          <p class="text-sm">This project doesn't have context data yet</p>
        </div>
      `;
      return;
    }

    const ctx = context.context;
    contextDetails.innerHTML = `
      <div class="space-y-6">
        <!-- Project Overview -->
        <div class="bg-navy-50 rounded-lg p-4">
          <h3 class="font-black text-navy-900 mb-3">üìã Project Overview</h3>
          <div class="grid grid-cols-2 gap-4 text-sm">
            <div><span class="font-semibold">Technologies:</span> ${(ctx.technologies || []).join(', ') || 'Not detected'}</div>
            <div><span class="font-semibold">Last Updated:</span> ${this.formatTimestamp(context.timestamp)}</div>
            <div><span class="font-semibold">Context Entries:</span> ${ctx.contextEntries || 0}</div>
            <div><span class="font-semibold">Business Logic Files:</span> ${ctx.businessLogicFiles || 0}</div>
          </div>
        </div>

        <!-- Key Findings -->
        ${ctx.keyFindings && ctx.keyFindings.length > 0 ? `
          <div>
            <h3 class="font-black text-navy-900 mb-3">üîç Key Findings</h3>
            <div class="space-y-2">
              ${ctx.keyFindings.map(finding => `
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                  <p class="text-sm text-navy-700">${this.escapeHtml(finding)}</p>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        <!-- Next Steps -->
        ${ctx.nextSteps && ctx.nextSteps.length > 0 ? `
          <div>
            <h3 class="font-black text-navy-900 mb-3">üéØ Next Steps</h3>
            <div class="space-y-2">
              ${ctx.nextSteps.map(step => `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                  <p class="text-sm text-navy-700">${this.escapeHtml(step)}</p>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}

        <!-- File Analysis -->
        ${ctx.fileAnalysis && Object.keys(ctx.fileAnalysis).length > 0 ? `
          <div>
            <h3 class="font-black text-navy-900 mb-3">üìÅ File Analysis</h3>
            <div class="bg-navy-50 rounded-lg p-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                ${Object.entries(ctx.fileAnalysis).map(([key, value]) => `
                  <div><span class="font-semibold">${this.capitalize(key)}:</span> ${Array.isArray(value) ? value.length : value}</div>
                `).join('')}
              </div>
            </div>
          </div>
        ` : ''}
      </div>
    `;
  }

  handleRealtimeEvent(event) {
    // Add to recent events
    const recentEvents = document.getElementById('recent-events');
    const eventHtml = `
      <div class="flex items-start gap-3 p-3 bg-navy-50 rounded-lg border-l-4 border-coral-500">
        <div class="flex-shrink-0 w-8 h-8 bg-coral-100 rounded-full flex items-center justify-center">
          <span class="text-coral-600 text-xs font-bold">${this.getEventIcon(event.type)}</span>
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-semibold text-navy-900">${event.type || 'Context Update'}</p>
          <p class="text-xs text-navy-600 mt-1">${event.message || 'Project context updated'}</p>
          <p class="text-xs text-navy-500 mt-1">${this.formatTimestamp(Date.now())}</p>
        </div>
      </div>
    `;

    if (recentEvents.innerHTML.includes('Waiting for context events')) {
      recentEvents.innerHTML = eventHtml;
    } else {
      recentEvents.insertAdjacentHTML('afterbegin', eventHtml);
      // Keep only last 10 events
      const events = recentEvents.children;
      if (events.length > 10) {
        events[events.length - 1].remove();
      }
    }

    // Refresh projects if this was a context update
    if (event.type === 'PROJECT_CONTEXT_SAVE') {
      this.loadProjects();
    }
  }

  updateStats() {
    // Update with actual data - placeholder for now
    document.getElementById('total-projects').textContent = '3';
    document.getElementById('total-projects-display').textContent = '3';
    document.getElementById('active-sessions').textContent = '1';
    document.getElementById('active-sessions-display').textContent = '1';
    document.getElementById('key-findings').textContent = '7';
    document.getElementById('key-findings-display').textContent = '7';
    document.getElementById('next-steps').textContent = '4';
    document.getElementById('next-steps-display').textContent = '4';
  }

  startStatsUpdate() {
    // Update stats every 30 seconds
    setInterval(() => this.updateStats(), 30000);
  }

  getEventIcon(eventType) {
    const icons = {
      'PROJECT_CONTEXT_SAVE': 'üíæ',
      'TOOL_CALL': 'üîß',
      'APPROVAL_REQUEST': 'üîê',
      default: 'üìä'
    };
    return icons[eventType] || icons.default;
  }

  formatTimestamp(timestamp) {
    if (!timestamp) return 'Never';
    const date = new Date(typeof timestamp === 'number' ? timestamp : Date.parse(timestamp));
    return date.toLocaleString();
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  showToast(message, type = 'info') {
    // Use the showToast function from admin_base.html if available
    if (typeof showToast === 'function') {
      showToast(message, type);
    } else {
      console.log(`${type.toUpperCase()}: ${message}`);
    }
  }
}

// Initialize dashboard
const dashboard = new ContextDashboard();
</script>
{% endblock %}